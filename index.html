<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUEST OF SHOTA: 26TH HBD</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>

    <div class="scanline"></div> <div id="main-content" class="nes-container">
        <audio id="game-bgm" src="8bit_adventure.mp3" loop></audio>
        <header id="header-area">
            <div class="corgi-container arcade-border">
                <img src="corgi.png" alt="ドット絵コーギー" id="corgi-img" class="pixelated">
                <div class="header-text text-shadow">将大！お誕生日、おめでとう</div>
            </div>
        </header>

        <section class="message-area arcade-border">
            <p>勇者ショウタよ。<br>このダンジョンには仕掛けがある。</p>
        </section>

        <section class="game-container arcade-border">
            <div class="game-header">
                <h3>STAGE 1: コロッケ奪還</h3>
                <p>JUMP: タップ / クリック</p>
                <p id="score-board">コロッケ: <span id="croquette-count">0</span> / 3</p>
            </div>
            <canvas id="gameCanvas" class="pixelated"></canvas>
            <button id="start-btn" class="nes-btn">PRESS START</button>
        </section>
    </div>

    <div id="hint-modal" class="modal hidden">
        <div class="modal-content arcade-border">
            <span class="close-btn" id="close-hint">×</span>
            <p>STAGE CLEAR!<br>上の<span class="highlight">「ドット犬」</span>を<br>5回 連打セヨ。</p>
        </div>
    </div>

    <div id="password-modal" class="modal hidden">
        <div class="modal-content arcade-border">
            <p>二人の記念日ヲ入力セヨ</p>
            <input type="text" id="pass-input" placeholder="0000" maxlength="4" class="nes-input">
            <button id="pass-submit" class="nes-btn">OK</button>
            <p id="error-msg" class="error hidden">ブブーッ！違イマス！</p>
        </div>
    </div>

    <div id="success-screen" class="hidden">
        <div class="success-content">
            <h1 class="text-shadow">QUEST COMPLETE!</h1>
            <p>ここまで来てくれてありがとう！<br>下の宝箱を開けてね！</p>
            
            <a href="https://youtu.be/9jZpQtLCQSU" target="_blank" class="chest-link">
                <img src="treasure_box.png" alt="宝箱" class="chest-img pixelated">
                <p class="click-hint blinking">PUSH START BUTTON!</p>
            </a>
        </div>
    </div>

<script>
        const CONFIG = {
            password: "0807",
            rubCountTarget: 5,
            targetCroquettes: 3 // 目標コロッケ数
        };

        // --- ゲームロジック (スマホ修正版) ---
        const gameContainer = document.querySelector('.game-container'); // タップ範囲拡大用
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const bgm = document.getElementById('game-bgm');
        const scoreBoard = document.getElementById('croquette-count');
        
        function resizeCanvas() {
            canvas.width = Math.min(window.innerWidth - 60, 600);
            canvas.height = 250;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let gameRunning = false;
        let animationId;
        let croquettesCollected = 0; 
        
        // プレイヤー
        const player = { x: 30, y: 150, w: 24, h: 24, dy: 0, jumpPower: -11, grounded: true, color: "#3498db" };
        const gravity = 0.8;
        const gameSpeed = 6; 
        
        let obstacles = [];
        let croquettesItems = []; 
        let frame = 0;
        const groundHeight = 30;

        function drawPixelRect(x, y, w, h, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, w, h);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.strokeRect(x+1, y+1, w-2, h-2);
        }

        function drawPlayer() {
            drawPixelRect(player.x, player.y, player.w, player.h, player.color);
            ctx.fillStyle = "#fff";
            ctx.fillRect(player.x + 14, player.y + 6, 6, 6);
        }

        function spawnObstacle() {
            const height = Math.random() > 0.5 ? 30 : 50;
            obstacles.push({ x: canvas.width, y: canvas.height - groundHeight - height, w: 24, h: height, color: "#e74c3c" });
        }

        function spawnCroquette() {
            const randomY = Math.random() * (canvas.height - groundHeight - 80) + 50;
            croquettesItems.push({ x: canvas.width, y: randomY, w: 32, h: 24, color: "#d35400", collected: false });
        }

        function updateGame() {
            if (!gameRunning) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 背景
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#8B4513"; 
            ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
            ctx.fillStyle = "#A0522D";
            for(let i=0; i<canvas.width; i+=20) {
                 ctx.fillRect(i, canvas.height - groundHeight + 5, 10, 10);
            }

            // プレイヤー
            player.dy += gravity;
            player.y += player.dy;

            if (player.y > canvas.height - groundHeight - player.h) {
                player.y = canvas.height - groundHeight - player.h;
                player.dy = 0;
                player.grounded = true;
            } else {
                player.grounded = false;
            }

            drawPlayer();

            // 障害物
            if (frame % 70 === 0) spawnObstacle();

            obstacles.forEach((obs, index) => {
                obs.x -= gameSpeed;
                drawPixelRect(obs.x, obs.y, obs.w, obs.h, obs.color);

                if (
                    player.x + 4 < obs.x + obs.w &&
                    player.x + player.w - 4 > obs.x &&
                    player.y + 4 < obs.y + obs.h &&
                    player.y + player.h - 2 > obs.y
                ) {
                    gameOver();
                }
                if (obs.x + obs.w < 0) obstacles.splice(index, 1);
            });

            // コロッケ
            if (frame % 250 === 0 && croquettesCollected < CONFIG.targetCroquettes) spawnCroquette();

            croquettesItems.forEach((item, index) => {
                if(item.collected) return;
                item.x -= gameSpeed;
                drawPixelRect(item.x, item.y, item.w, item.h, item.color);

                if (
                    player.x < item.x + item.w &&
                    player.x + player.w > item.x &&
                    player.y < item.y + item.h &&
                    player.y + player.h > item.y
                ) {
                    item.collected = true;
                    croquettesCollected++;
                    scoreBoard.innerText = croquettesCollected; 
                    croquettesItems.splice(index, 1); 

                    if (croquettesCollected >= CONFIG.targetCroquettes) {
                        gameWin();
                    }
                }
                if (item.x + item.w < 0) croquettesItems.splice(index, 1);
            });

            frame++;
            animationId = requestAnimationFrame(updateGame);
        }

        // --- ジャンプ処理 ---
        function jump(e) {
            // ゲーム中以外は反応しない
            if (!gameRunning) return;
            
            // スマホのスクロール防止
            if(e && e.type === 'touchstart') e.preventDefault();

            if (player.grounded) {
                player.dy = player.jumpPower;
                player.grounded = false;
            }
        }

        function resetGame() {
            player.y = canvas.height - groundHeight - player.h;
            player.dy = 0;
            obstacles = [];
            croquettesItems = [];
            croquettesCollected = 0;
            scoreBoard.innerText = 0;
            frame = 0;
        }

        function gameOver() {
            gameRunning = false;
            alert("GAME OVER... リトライ！");
            resetGame();
            startBtn.style.display = "inline-block"; // ボタン再表示
            startBtn.innerText = "RETRY";
        }

        function gameWin() {
            gameRunning = false;
            try { bgm.pause(); } catch(e){}
            document.getElementById('hint-modal').classList.remove('hidden');
        }

        // --- イベントリスナー修正版 ---

        // 1. スタートボタンはシンプルにクリックのみ監視（スマホもタップ＝クリックとして扱われる）
        startBtn.addEventListener('click', () => {
            if (gameRunning) return;
            resetGame();
            gameRunning = true;
            try { bgm.play(); } catch(e){ console.log("BGM start failed"); }
            
            // ボタンを押した後、ボタン自体を一時的に隠すかテキストを変える
            // ここでは誤タップ防止のためボタンの見た目を変えるだけにします
            startBtn.innerText = "JUMP!";
            
            updateGame();
        });

        // 2. ジャンプ操作：ゲームコンテナ全体で反応させる（Canvas外枠をタップしてもOKにする）
        // スマホ用：パッシブ設定をfalseにしてpreventDefaultを効かせる
        gameContainer.addEventListener('touchstart', jump, {passive: false});
        
        // PC用：マウスダウン
        gameContainer.addEventListener('mousedown', jump);

        // --- ポップアップ閉じる ---
        document.getElementById('close-hint').addEventListener('click', () => {
            document.getElementById('hint-modal').classList.add('hidden');
        });

        // --- ヘッダー連打ギミック ---
        const corgiImg = document.getElementById('corgi-img');
        let rubCount = 0;
        let rubTimer;

        corgiImg.addEventListener('click', () => {
            corgiImg.style.transform = "translate(5px, 0)";
            setTimeout(() => { corgiImg.style.transform = "translate(-5px, 0)"; }, 50);
            setTimeout(() => { corgiImg.style.transform = "translate(0, 0)"; }, 100);

            rubCount++;
            clearTimeout(rubTimer);
            rubTimer = setTimeout(() => { rubCount = 0; }, 800);

            if (rubCount >= CONFIG.rubCountTarget) {
                document.getElementById('password-modal').classList.remove('hidden');
                rubCount = 0;
            }
        });

        // --- パスワード認証 ---
        const passSubmit = document.getElementById('pass-submit');
        const passInput = document.getElementById('pass-input');

        passSubmit.addEventListener('click', checkPass);

        function checkPass() {
            if (passInput.value === CONFIG.password) {
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('password-modal').classList.add('hidden');
                document.getElementById('hint-modal').classList.add('hidden');
                
                const successScreen = document.getElementById('success-screen');
                successScreen.classList.remove('hidden');
                successScreen.classList.add('visible');
            } else {
                document.getElementById('error-msg').classList.remove('hidden');
                passInput.value = "";
            }
        }
    </script>
</body>
</html>